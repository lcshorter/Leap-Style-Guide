WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.drag-and-drop:image-dialog-client', location = 'js/image-dialog-client.js' */
define("confluence-drag-and-drop/image-dialog-client","jquery ajs confluence/meta underscore confluence-drag-and-drop/files-uploader-factory confluence/legacy-editor-global-AVOID-IF-POSSIBLE confluence-drag-and-drop/insert-dialog-upload-controller confluence-drag-and-drop/upload-utils confluence-drag-and-drop/drag-and-drop-utils".split(" "),function(m,i,h,n,p,g,q,o,r){var k=function(){this._workIdToBytesUploaded={};this._totalBytes=0};k.prototype={update:function(a,f,e){if(!(a in this._workIdToBytesUploaded))this._totalBytes=
this._totalBytes+e;this._workIdToBytesUploaded[a]=f},percentComplete:function(){var a=0;m.each(this._workIdToBytesUploaded,function(f,e){a=a+e});return Math.round(a*100/this._totalBytes)}};var l=p.get(),j=function(a){this.pageId=parseInt(h.get("page-id"),10);this.draftId=parseInt(h.get("draft-id"),10);this.dragAndDropEntityId=h.get("drag-and-drop-entity-id");this.spaceKey=h.get("space-key")||"";this.atlToken=h.get("atl-token");this.base=/^\w+:\/\/[^\/?#]+/.exec(location.href);this.metaMaxFileSize=
h.get("global-settings-attachment-max-size");this.errors=[];this.batchProgress=new k;this.attachmentPanelComponent=a.attachmentPanelComponent;this.dropZone=a.dropZone;this.browserButtonId=a.browserButtonId;this.uploader=null;this.isUploadUsingDragAndDrop=false;var f=this;m(this.dropZone).bind("drop",function(){f.isUploadUsingDragAndDrop=true})};j.prototype.createPlupload=function(){var a=this,f=function(d){if(d){var b,c;if(d.generalError){c=[d.generalError.message];b=d.generalError.fileIds}else if(d.fileErrors){c=
[];b=[];n.each(d.fileErrors,function(a){b.push(a.id);c.push(a.message)})}if(c&&c.length){a.attachmentPanelComponent.displayErrors(c);a.errors=a.errors.concat(c)}b&&b.length&&n.each(b,function(b){a.attachmentPanelComponent.attachmentUploadingCancelled(b);a.cancelUpload(b)})}},e=new plupload.Uploader({runtimes:"html5",dragdrop:true,drop_element:a.dropZone,browse_button:a.browserButtonId,multipart:false,stop_propagation:true,max_file_size:parseInt(a.metaMaxFileSize,10),inputFileClazz:"file-library-input-file"});
e.init();e.bind("Started",function(d,b){a.errors=[];a.attachmentPanelComponent.clearErrors();a.batchProgress=new k;require(["conf/confluence-drag-and-drop/analytics/files-upload-analytics"],function(c){c.triggerEvent(a.isUploadUsingDragAndDrop?"confluence.insert-files-dialog.drag-and-drop":"confluence.insert-files-dialog.upload",b);a.isUploadUsingDragAndDrop=false})});e.bind("FilesAdded",function(d,b){function c(b,c){for(var d=0;d<c.length;d++)if(c[d].status===plupload.FAILED)b.removeFile(c[d]);else{var e=
n.find(b.files,function(a){return a.name===c[d].name&&a.id!==c[d].id});e&&b.removeFile(e);a.metaMaxFileSize>c[d].size&&a.attachmentPanelComponent.addPreviewImage(c[d])}l.filesAdded(b,c,a).then(function(a){f(a);b.start()})}if(b.length>0){a.attachmentPanelComponent.getNoFileContainer().hide();o.filterFiles(d,b,c)}});e.bind("BeforeUpload",function(d,b){l.beforeUpload(d,b,a);a.batchProgress=new k});e.bind("UploadProgress",function(d,b){a.batchProgress.update(b.id,b.loaded,b.size);a.attachmentPanelComponent.setUploadInProgress(a.batchProgress.percentComplete()/
100,b.id)});e.bind("FileUploaded",function(d,b,c){d.getFile(b.id)?l.fileUploaded(d,b,c).done(function(b){a.attachmentPanelComponent.attachmentUploaded(b.fileId,b.fileServerId)}).fail(function(a){f(a)}):a.attachmentPanelComponent.attachmentUploadingCancelled(b.id)});e.bind("Error",function(d,b){var c="";if(b.response){c=l.serverError(b.response)||b.message;a.attachmentPanelComponent.displayErrors([c]);a.errors.push(c);i.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.server-unknown"})}else{var c=
b.message,e=b.file.name;if(b.code===plupload.FILE_SIZE_ERROR){c=r.niceSize(a.metaMaxFileSize).toString();c=i.format("{0} is too big to upload. Files must be less than {1}.",e,c);i.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.file-size"})}else if(b.code===o.ErrorCode.FILE_IS_A_FOLDER_ERROR){c=i.format("Cannot upload {0} - it might be a folder or an unsupported file type.",e);i.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.file-type"})}a.attachmentPanelComponent.displayErrors([c]);
a.errors.push(c)}});require(["conf/confluence-drag-and-drop/drag-and-drop-overlay"],function(d){d.bindFileDragOverlay({$dragZone:m(a.dropZone),zIndex:3005})});return e};j.prototype.init=function(){this.uploader=this.createPlupload()};j.prototype.cancelUpload=function(a){(a=this.uploader.getFile(a))&&this.uploader.removeFile(a)};if(g&&g.FileDialog)g.FileDialog.eventListener.on("AttachmentsPanelView.render",function(a){a.getUploaderController=function(){return new q(a.context)}});i.toInit(function(){if(g&&
g.ImageDialog){var a=g.ImageDialog.beforeShowListeners,f=g.ImageDialog.findPanelComponentById("attachments");a&&a.push(function(){if(f){var a=f.getPanelElement();if(a.length&&h.getBoolean("can-attach-files")){var d=new j({dropZone:a[0],browserButtonId:"upload-files-button",attachmentPanelComponent:f});d.init();g.FileDialog.eventListener.on("uploadingfile.cancelled",function(a){d.cancelUpload(a)})}}else console.debug("Do not support Attachment Panel and Drag-Drop in Insert Image Dialog (ex: in creating Template)")})}});
return j});require("confluence/module-exporter").safeRequire("confluence-drag-and-drop/image-dialog-client");
}catch(e){WRMCB(e)};