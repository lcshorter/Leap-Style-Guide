WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/template/synchrony-presence.soy' */
// This file was automatically generated from synchrony-presence.soy.
// Please don't edit this file by hand.

/**
 * @fileoverview Templates in namespace Confluence.Templates.SynchronyPresence.
 */

if (typeof Confluence == 'undefined') { var Confluence = {}; }
if (typeof Confluence.Templates == 'undefined') { Confluence.Templates = {}; }
if (typeof Confluence.Templates.SynchronyPresence == 'undefined') { Confluence.Templates.SynchronyPresence = {}; }


Confluence.Templates.SynchronyPresence.container = function(opt_data, opt_ignored) {
  return '<ul id="avatar-list" class="synchrony-doc-' + soy.$$escapeHtml(opt_data.docId) + ' collaborative-avatars-list"></ul><aui-inline-dialog id="more-avatars" alignment="bottom right" responds-to="toggle" aria-hidden="true"><h3>' + soy.$$escapeHtml('More editors') + '</h3><ul id="more-avatars-list" class="collaborative-avatars-list"></ul></aui-inline-dialog>';
};
if (goog.DEBUG) {
  Confluence.Templates.SynchronyPresence.container.soyTemplateName = 'Confluence.Templates.SynchronyPresence.container';
}


Confluence.Templates.SynchronyPresence.avatar = function(opt_data, opt_ignored) {
  return '<li class="avatar-item' + ((opt_data.active) ? ' p' + soy.$$escapeHtml(opt_data.telepointer) + ' active' : '') + '"><span title="' + soy.$$escapeHtml(opt_data.fullname) + ' ' + ((opt_data.active) ? soy.$$escapeHtml('is editing this page.') : soy.$$escapeHtml('has made changes that haven\x27t been published.')) + '" avatar="' + soy.$$escapeHtml(opt_data.initial) + '"' + ((opt_data.active) ? ' data-origin="' + soy.$$escapeHtml(opt_data.origin) + '"' : '') + ' class="avatar' + ((opt_data.active) ? ' active' : '') + '"><img src="' + soy.$$escapeHtml(opt_data.avatarUrl) + '"></span></li>';
};
if (goog.DEBUG) {
  Confluence.Templates.SynchronyPresence.avatar.soyTemplateName = 'Confluence.Templates.SynchronyPresence.avatar';
}


Confluence.Templates.SynchronyPresence.overlay = function(opt_data, opt_ignored) {
  return '<span id="synchrony-presence-overlay" class="overlay avatar"><a href="#" aria-controls="more-avatars" class="aui-button" data-aui-trigger></a></span>';
};
if (goog.DEBUG) {
  Confluence.Templates.SynchronyPresence.overlay.soyTemplateName = 'Confluence.Templates.SynchronyPresence.overlay';
}

}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/synchrony-presence.js' */
define("confluence-collaborative-editor-plugin/synchrony-presence","backbone confluence-collaborative-editor-plugin/avatar-list-view confluence-collaborative-editor-plugin/overlay-view ajs confluence/meta confluence/templates jquery underscore".split(" "),function(i,r,n,e,o,s,j,f){function k(){var d=[];b.each(function(a){!a.get("active")&&!f.some(g,function(b){return a.get("id")===b.name})&&d.push(a)});f.each(d,function(a){b.remove(a)});f.each(g,function(a){if(!(a.name===o.get("remote-user")||b.any(function(b){return b.get("id")===
a.name||b.get("name")===a.name}))){a.active=false;a.id=a.name;b.add(a)}})}var b=new i.Collection,p=false,q="",h,g=[];return{appendTo:function(d,a,i,l,t){q=d;d=null;if(!p){h=h||require("tinymce");if(!l){e.log("synchronyPresence error: specify a valid container.");return}p=true;d=j(s.SynchronyPresence.container({docId:i}));j(l).append(d);new r({el:"#avatar-list",collection:b});var m=new n({collection:b});j(l).append(m.render());g=t;k();e.bind("editor-heartbeat",function(b,c){if(f.isArray(c.contributors)){g=
c.contributors;k()}});a.on("presence",function(a){m.hideInlineDialog();a.joined.filter(function(c){return c.origin!==q}).forEach(function(c){c.id=c.origin;c.fullname=c.fullname||"Anonymous";c.name=c.name||"anonymous";c.avatarURL=e.contextPath()+c.avatarURL;c.active=true;var a=b.findWhere({active:false,id:c.name});a&&b.remove(a);b.add(c,{at:b.filter(function(a){return a.get("active")}).length})});a.left.forEach(function(a){a.id=a.origin;b.remove(a);k()});e.trigger("analyticsEvent",
{name:"confluence.synchrony.user.in.session",data:{numOtherUsers:b.length,draftId:o.get("draft-id")}})});h.EditorManager.activeEditor.onClick.add(f.bind(n.prototype.hideInlineDialog,m))}return d},setTinyMce:function(b){h=b}}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/avatar-list-view.js' */
define("confluence-collaborative-editor-plugin/avatar-list-view",["backbone","confluence-collaborative-editor-plugin/avatar-view","ajs","jquery","underscore"],function(d,e,c,g,f){return d.View.extend({initialize:function(){this.collection.on("add",this.addAvatar,this);this.collection.on("remove",this.removeAvatar,this);this.collection.each(this.addAvatar,this)},addAvatar:function(a){var b=new e({model:a});a.get("active")?(c.log(a.get("fullname")+" joined. ("+a.get("origin")+")"),a=this.$el.find("li.active").last(),
b=a.length?b.render().insertAfter(a):b.render().prependTo(this.$el)):b=b.render().appendTo(this.$el);a=function(a){a.addClass("show");a.children(".avatar").tooltip({fade:true,gravity:"ne"})};6===this.collection.length?a(b):f.defer(a,b);this._manageOverlayClass()},removeAvatar:function(a){a.get("active")&&c.log(a.get("fullname")+" left. ("+a.get("origin")+")");this._manageOverlayClass()},_manageOverlayClass:function(){var a=this.collection.length;this.collection.each(function(b,c){b.set("hidden",5<
a&&4<=c)});5<a?this.$el.addClass("has-overlay"):this.$el.removeClass("has-overlay")}})});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/avatar-view.js' */
define("confluence-collaborative-editor-plugin/avatar-view",["backbone","ajs","confluence/templates","jquery"],function(e,g,f,d){return e.View.extend({initialize:function(){this.model.on("remove",this.remove,this)},render:function(){return this.$el=d(f.SynchronyPresence.avatar({fullname:this.model.get("fullname"),initial:this.model.get("fullname").charAt(0).toUpperCase(),avatarUrl:this.model.get("avatarURL"),origin:this.model.get("origin"),active:this.model.get("active"),telepointer:this._synchronyTelepointerId()}))},
remove:function(){this.$el.removeClass().addClass("avatar-item animate");this.model.get("hidden")||this.$el.addClass("removing");this.$el.one(this._getSupportedTransition(),function(){d(this).removeClass("animate removing");d(this).remove()})},_getSupportedTransition:function(){var c={transition:"transitionend",MozTransition:"transitionend",OTransition:"oTransitionEnd",MsTransition:"msTransitionEnd",WebkitTransition:"webkitTransitionEnd"},a=document.createElement("_"),b;for(b in c)if(void 0!==a.style[b])return c[b]},
_synchronyTelepointerId:function(){for(var c=""+(this.model.get("sub")||this.model.get("origin")||""),a=0,b=0;b<c.length;b++)a=(a<<5)-a+c.charCodeAt(b),a&=a;return Math.abs(a)%10}})});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/overlay-view.js' */
define("confluence-collaborative-editor-plugin/overlay-view","backbone aui/inline-dialog2 confluence-collaborative-editor-plugin/avatar-view confluence/templates ajs jquery underscore".split(" "),function(c,g,d,e,f,b){return c.View.extend({initialize:function(){this.collection.on("add remove",this.reconcile,this);this.inlineDialog2=document.querySelector("#more-avatars")},render:function(){this.$el=b(e.SynchronyPresence.overlay());this.$el.children("a").tooltip({fade:true,gravity:"ne"});this.$el.on("click",
function(){b(".tipsy").remove()});return this.$el},reconcile:function(){var a=this.collection.where({hidden:true});if(a.length>0){this.$el.addClass("show");this.$el.children(".aui-button").html("+"+a.length).attr("title",a.length+" "+"other users are editing.");b("#more-avatars-list").children().remove();a.forEach(function(a){a=new d({model:a});b("#more-avatars-list").append(a.render())})}else{this.$el.removeClass("show");this.hideInlineDialog()}},hideInlineDialog:function(){if(this.inlineDialog2&&
this.inlineDialog2.isVisible&&this.inlineDialog2.isVisible())this.inlineDialog2.open=false}})});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/template/status-indicator.soy' */
// This file was automatically generated from status-indicator.soy.
// Please don't edit this file by hand.

/**
 * @fileoverview Templates in namespace Confluence.Templates.CollaborativeEditor.StatusIndicator.
 */

if (typeof Confluence == 'undefined') { var Confluence = {}; }
if (typeof Confluence.Templates == 'undefined') { Confluence.Templates = {}; }
if (typeof Confluence.Templates.CollaborativeEditor == 'undefined') { Confluence.Templates.CollaborativeEditor = {}; }
if (typeof Confluence.Templates.CollaborativeEditor.StatusIndicator == 'undefined') { Confluence.Templates.CollaborativeEditor.StatusIndicator = {}; }


Confluence.Templates.CollaborativeEditor.StatusIndicator.container = function(opt_data, opt_ignored) {
  return '<div class="synchrony-status-indicator"><div class="status-indicator-icon aui-icon aui-icon-small' + ((opt_data.error) ? ' aui-iconfont-warning' : (opt_data.saving) ? ' aui-iconfont-devtools-task-in-progress' : ' aui-iconfont-approve') + '" data-tooltip="' + soy.$$escapeHtml(opt_data.tooltipMessage) + '"></div><div class="status-indicator-message" data-tooltip="' + soy.$$escapeHtml(opt_data.tooltipMessage) + '">' + ((opt_data.error || opt_data.saving) ? soy.$$escapeHtml(opt_data.statusMessage) : (opt_data.isReadyToGo) ? soy.$$escapeHtml(opt_data.statusMessage) : '<a href="#">' + soy.$$escapeHtml(opt_data.statusMessage) + '</a>') + '</div></div>';
};
if (goog.DEBUG) {
  Confluence.Templates.CollaborativeEditor.StatusIndicator.container.soyTemplateName = 'Confluence.Templates.CollaborativeEditor.StatusIndicator.container';
}

}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/status-indicator-view.js' */
define("confluence-collaborative-editor-plugin/status-indicator-view",["confluence/templates","backbone","ajs","jquery","underscore"],function(e,f,c,g,d){return f.View.extend({initialize:function(){this.$el.addClass("synchrony");this.listenTo(this.model,"change:saving change:error",this.render);this.model.set("confluenceUnreachable",!1);this.model.set("synchronyUnreachable",!1);this.model.set("tokenExpired",!1);c.bind("rte.heartbeat",d.bind(this.onConfluenceConnectedState,this));c.bind("rte.safe-save.error",
d.bind(this._errorPublishing,this));c.bind("rte.preview.error",d.bind(this._errorPublishing,this));this.model.set("connecting",!0);this._setProgressState()},render:function(){g(".tipsy").remove();this.$el.html(e.CollaborativeEditor.StatusIndicator.container(this.model.attributes))},onConnectedState:function(a){this.model.set("synchronyUnreachable",!1);if(!this.model.has("synchronyEntity")){this.model.set("synchronyEntity",a);var b=this;this.model.get("synchronyEntity").on("update",function(a){b._handleSynchronyUpdateEvent(a,
b)});this.model.get("synchronyEntity").on("ack",function(a){b._handleSynchronyAckEvent(a,b)})}this._setSavedState()},onDisconnectedState:function(){this.model.set("synchronyUnreachable",!0);this.model.set("connecting",!0);this._setErrorState()},onConfluenceConnectedState:function(){this.model.get("confluenceUnreachable")&&(this.model.set("confluenceUnreachable",!1),this._setSavedState())},onConfluenceDisconnectedState:function(){this.model.set("confluenceUnreachable",!0);this.model.set("connecting",
!0);this._setErrorState()},onTokenRenewedState:function(){this.model.get("tokenExpired")&&(this.model.set("tokenExpired",!1),this._setSavedState())},onTokenExpiredState:function(){this.model.set("tokenExpired",!0);this.model.set("connecting",!0);this._setErrorState()},_handleSynchronyUpdateEvent:function(a,b){"local"===a.updateType&&(b.model.set("pendingChanges",!0),b._saving())},_handleSynchronyAckEvent:function(a,b){var c=0<a.pending.length;b.model.set("pendingChanges",c);c||b.model.set("lastSavedTime",
(new Date).getTime())},_saving:function(){var a=this,b=function(){setTimeout(function(){a.model.get("pendingChanges")||(new Date).getTime()-a.model.get("lastSavedTime")<a.model.get("minActiveTime")?b():a._setSavedState()},a.model.get("minActiveTime"))};this.model.get("saving")||(this.model.set("connecting",!1),this._setProgressState(),b())},_reachable:function(){return!this.model.get("confluenceUnreachable")&&!this.model.get("synchronyUnreachable")&&!this.model.get("tokenExpired")},_errorPublishing:function(a,
b){switch(b.status){case 0:this.onConfluenceDisconnectedState();break;case 500:case 503:this.onConfluenceDisconnectedState()}},_setSavedState:function(){this._reachable()?(this.model.set("statusMessage",this.model.get("connecting")?"Ready to go":"Changes saved"),this.model.set("isReadyToGo",this.model.get("connecting")?!0:!1),this.model.set("tooltipMessage","We\'re automatically saving all of your changes in a draft. Click to view changes."),this.model.set("connecting",!1),this.model.set("saving",
!1),this.model.set("error",!1)):this._setErrorState()},_setErrorState:function(){this.model.set("statusMessage","Can\'t save changes");this.model.set("tooltipMessage","Can\'t reach the server. Check your internet connection, and we\'ll keep trying to reconnect you.");this.model.set("saving",!1);this.model.set("error",!0)},_setProgressState:function(){this._reachable()?(this.model.set("statusMessage",this.model.get("connecting")?"Connecting...":"Saving changes"),this.model.set("tooltipMessage",
"We\'re automatically saving all of your changes in a draft. Click to view changes."),this.model.set("saving",!0),this.model.set("error",!1)):this._setErrorState()}})});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/initialise-metrics.js' */
define("confluence-collaborative-editor-plugin/initialise-metrics",["confluence/performance-session"],function(a){return function(){a.register("confluence.editor.quickedit.loading.times",{"confluence.editor":!0,"confluence.editor.preload":!0,"confluence.editor.quick.fetchContent":!0,"confluence.editor.tinymce":!0,"confluence.editor.synchrony":!0,"confluence.editor.synchrony.CR":!0,"confluence.editor.synchrony.connect":!0,"confluence.editor.synchrony.deps":!0,"confluence.editor.synchrony.init":!0,
"confluence.editor.synchrony.jsLoad":!0,"confluence.editor.synchrony.snapshot":!0,"confluence.editor.synchrony.unmarshal":!0},{"confluence.editor.synchrony.connect":!0})}});require("confluence/module-exporter").safeRequire("confluence-collaborative-editor-plugin/initialise-metrics",function(a){a()});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/sync-manager.js' */
define("confluence-collaborative-editor-plugin/sync-manager",["ajs","jquery"],function(d,e){var f=["id"],g={START_SYNCHRONIZING_EVENT_NAME:"start",STOP_SYNCHRONIZING_EVENT_NAME:"stop",MAX_CONSECUTIVE_AUTO_RECOVERY_TRIGGERED:10,MAX_WAIT_TIME_TO_RESTART:3E4,DEBUG_MODE:!1},b=function(a,c){this.entity=a;this.settings=e.extend({},g,c||{});this.controlSyncState={};this.recoveryTimeoutTasks={};var b=function(a,c,b){f.every(function(a){return"undefined"!==typeof b[a]})?a(b):this.displayLogMessage("Invalid payload, missing required params",
c,b)};d.bind("synchrony."+this.settings.START_SYNCHRONIZING_EVENT_NAME,b.bind(this,this.enableSynchronization.bind(this)));d.bind("synchrony."+this.settings.STOP_SYNCHRONIZING_EVENT_NAME,b.bind(this,this.disableSynchronization.bind(this)))};b.prototype.getOrCreateControlSyncState=function(a){return this.controlSyncState[a]=this.controlSyncState[a]||{DISABLED_SYNC_STATUS:!1,RECOVERY_TIMER_RUNNING:!1,CONSECUTIVE_AUTO_RECOVERY_TRIGGERED:0}};b.prototype.enableDebug=function(a){this.settings.DEBUG_MODE=
"undefined"!==typeof a?a:!0};b.prototype.displayLogMessage=function(){if(this.settings.DEBUG_MODE){var a=Array.prototype.slice.call(arguments);a.splice(0,0,"DEBUG: "+(new Date).toLocaleTimeString());console.log.apply(console,a)}};b.prototype.disableSynchronization=function(a){var c=a.id;this.getOrCreateControlSyncState(c).DISABLED_SYNC_STATUS=!0;this.clearAutoRecoveryTimer(c);this.setAutoRecoveryTimer(a);this.entity.stop(c);this.displayLogMessage("Stoping entity synchronization",c,e.extend(!0,{},
this.controlSyncState))};b.prototype.enableSynchronization=function(a){a=a.id;this.getOrCreateControlSyncState(a).DISABLED_SYNC_STATUS=!1;this.clearAutoRecoveryTimer(a);this.entity.start(a);this.displayLogMessage("Starting entity synchronization",a,e.extend(!0,{},this.controlSyncState))};b.prototype.clearAutoRecoveryTimer=function(a){var c=this.getOrCreateControlSyncState(a);clearTimeout(this.recoveryTimeoutTasks[a]);delete this.recoveryTimeoutTasks[a];c.RECOVERY_TIMER_RUNNING=!1};b.prototype.setAutoRecoveryTimer=
function(a){var c=a.id,b=this.getOrCreateControlSyncState(c);b.RECOVERY_TIMER_RUNNING=!0;this.recoveryTimeoutTasks[c]=setTimeout(function(){this.displayLogMessage("Auto recovery has been triggered",c);this.clearAutoRecoveryTimer(c);b.DISABLED_SYNC_STATUS=!1;b.RECOVERY_TIMER_RUNNING=!1;b.CONSECUTIVE_AUTO_RECOVERY_TRIGGERED++;d.trigger("analyticsEvent",{name:"confluence.synchrony.syncmanager.failed-to-restart",data:{id:c}});b.CONSECUTIVE_AUTO_RECOVERY_TRIGGERED>=this.settings.MAX_CONSECUTIVE_AUTO_RECOVERY_TRIGGERED&&
(this.displayLogMessage("Auto recovery has been triggered too many times for the same action",c,this.controlSyncState[c].CONSECUTIVE_AUTO_RECOVERY_TRIGGERED),d.trigger("analyticsEvent",{name:"confluence.synchrony.syncmanager.consecutive-failed-to-restart",data:{id:c}}));this.entity.start(c)}.bind(this),a.maxWaitTimeToRestart||this.settings.MAX_WAIT_TIME_TO_RESTART)};return b});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/telepointer-cleaner.js' */
define("confluence-collaborative-editor-plugin/telepointer-cleaner",["confluence-editor-reliable-save/reliable-save","jquery"],function(a,c){a.registerCleanupFunction(function(a){var b=c("<div>");b.append(a);b.find(".synchrony-container, .synchrony-tp").remove();return b.html()})});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/editor-blanket.js' */
define("confluence-collaborative-editor-plugin/editor-blanket",["ajs","jquery","confluence/meta","confluence-editor/support/atlassian-editor-support"],function(j,a,k,h){var c,d,e;function f(b){switch(b){case "block":c="editor-block";d="aria-disabled";e="";break;default:c="editor-loading editor-loading-spinner",d="aria-busy",e="editor-loading"}b=a("#editpageform, #createpageform");b.addClass(c);b.attr(d,!0);a("#content-title").attr("tabindex",-1);a("#wysiwygTextarea_ifr").attr("tabindex",-1);a(".aui-toolbar2-primary").addClass(e)}
function i(){var b=a("#editpageform, #createpageform");b.removeClass(c);b.attr(d,!1);a("#rte").css("opacity",1).addClass("editor-blanket-ease-in");a("#content-title").attr("tabindex",1);a("#wysiwygTextarea_ifr").attr("tabindex",100);a("#content-title-div").css("opacity",1).addClass("editor-blanket-ease-in");a(".aui-toolbar2-primary").removeClass(e);e=d=c=void 0}function g(){a("#rte").css("opacity",1);a("#content-title-div").css("opacity",1)}e=d=c=void 0;return{applyBlanket:function(a){h.isCollaborativeContentType()&&
"pending"===a.state()?(f(),a.done(i)):g()},showEditor:g,showBlanket:f}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/synchrony-auth.js' */
define("confluence-collaborative-editor-plugin/synchrony-auth",["jquery","ajs","confluence/meta","confluence/get-content-id","confluence-collaborative-editor-plugin/synchrony-util"],function(i,d,j,k,f){function g(b){var c=i.Deferred(),a;if(a=!b)a=parseInt(f.retrieveMetadata("synchrony-expiry")),a=isNaN(a)?!1:a>Date.now()/1E3;a?c.resolve(f.retrieveMetadata("synchrony-token")):(d.log("["+new Date+"] Synchrony JWT expired or invalid, retrieving new token."),f.time("confluence.editor.synchrony.token"),
a=b&&b.errorType?"?errorType="+b.errorType:"",i.ajax({dataType:"json",method:"GET",url:encodeURI(d.contextPath()+"/rest/synchrony/1.0/token/"+k()+"/generate"+a)}).done(function(a){j.set("synchrony-token",a.synchronyToken);j.set("synchrony-expiry",a.synchronyExpiry);h=0;c.resolve(a.synchronyToken);e&&(e.onConfluenceConnectedState(),e.onTokenRenewedState());d.trigger("dismiss.editor.error.message",{messageKey:"synchrony-token-expired",enablePublish:!0});d.debug("Synchrony JWT token updated.");f.timeEnd("confluence.editor.synchrony.token")}).fail(function(){h++;
10<=h&&d.trigger("editor.error.message",{messageKey:"synchrony-token-expired",message:"We couldn\'t process your request, as it was missing a required security token. Copy your work, then re-submit the form or reload the page.",disablePublish:!0});e&&(e.onConfluenceDisconnectedState(),e.onTokenExpiredState());d.log(b?b.message:"Confluence failed to renew JWT token.");c.reject("token")}));return c.promise()}var e,h=0;return{init:function(b){e=b},performRequest:function(b){return g().pipe(b).pipe(function(c){var a;a="error"===c[1]&&c[0].responseText?JSON.parse(c[0].responseText):
c[0];return"error"===c[1]&&a.type&&a.type.match(/^jwt\//)?g({errorType:a.type,message:a.message}).pipe(b):c})},getTokenPromise:g}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/unsupported-extension.js' */
define("confluence-collaborative-editor-plugin/unsupported-extension","ajs jquery confluence-editor/editor/page-editor-message window confluence-collaborative-editor-plugin/editor-blanket confluence/legacy-editor-global-AVOID-IF-POSSIBLE".split(" "),function(a,c,e,f,g,d){return{check:function(){var b=a.Rte.getEditor().getBody();if(b.hasAttribute("data-gramm")&&b.hasAttribute("data-gramm_id")){a.trigger("synchrony.stop",{id:"confluence.editor.block.by.grammarly",maxWaitTimeToRestart:31536E6});a.trigger("analyticsEvent",
{name:"confluence.synchrony.editor.grammarly.block"});b.setAttribute("contentEditable",false);c(b).find(".contentLayout2 .innerCell").each(function(){this.setAttribute("contentEditable",false)});g.showBlanket("block");d.UI.setButtonsState(false,d.UI.buttons);e.handleMessage("collaborative-editor-unsupported-extension",{type:"error",title:"Grammarly isn\'t supported",message:a.format("The Grammarly extension doesn\'\'t play well with collaborative editing. Disable it and \u003ca {0}\u003ereload the page\u003c/a\u003e to keep working.",'href="#" id="collabGrammarlyReload"')});c("#collabGrammarlyReload").click(function(){a.trigger("analyticsEvent",
{name:"confluence.synchrony.editor.grammarly.reload.click"});f.location.reload();return false});a.trigger("synchrony-unsupported-extension")}}}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/synchrony-entity.js' */
define("confluence-collaborative-editor-plugin/synchrony-entity",["jquery","ajs","confluence-collaborative-editor-plugin/synchrony-auth","confluence-collaborative-editor-plugin/synchrony-util","confluence-collaborative-editor-plugin/unsupported-extension"],function(c,g,h,d,j){function k(b,d,e){var f,i,h=/^[\w\.\-\+\%]+$/i;i=function(a){return null==a||h.test(a)};f=c.extend({},b.whitelists.tinymce,{styles:c.extend({},b.whitelists.tinymce.styles,{"padding-top":!1,"padding-right":!1,"padding-bottom":!1,
"padding-left":!1,padding:!1,display:i,"list-style-type":i}),attributes:c.extend({},b.whitelists.tinymce.attributes,{"confluence-query-params":!0,"data-element-title":!0,"data-ref":!0,accesskey:!0,datetime:!0,"data-anchor":!0,"data-encoded-xml":!0,"data-highlight-class":!0,"data-highlight-colour":!0,"data-space-key":!0,"data-username":!0,"data-entity-id":!0,"data-entity-type":!0,"data-favourites-bound":!0,"data-macro-id":!0,"data-macro-name":!0,"data-macro-schema-version":!0,"data-macro-body-type":!0,
"data-macro-parameters":!0,"data-macro-default-parameter":!0,"data-atlassian-layout":!0,"data-placeholder-type":!0,"data-layout":!0,"data-title":!0,"data-type":!0,"data-inline-task-id":!0,"data-inline-tasks-content-id":!0,"data-base-url":!0,"data-linked-resource-id":!0,"data-linked-resource-type":!0,"data-linked-resource-version":!0,"data-linked-resource-default-alias":!0,"data-linked-resource-container-version":!0,"data-linked-resource-content-type":!0,"data-unresolved-comment-count":!0,"data-location":!0,
"data-image-height":!0,"data-image-width":!0,"data-attachment-copy":!0,"data-content-title":!0}),classes:function(a){switch(a){case "mceSelected":return!1;default:return!0}},elements:c.extend({},b.whitelists.tinymce.elements,{time:!0,mark:!0,label:!0,form:!0})});return{profile:"tinymce",selectionCorrections:!1,telepointer:{refreshOnResize:!0,label:{hover:!0,movement:1E3,text:function(a){try{return(a.fullname||"Anonymous").charAt(0).toUpperCase()}catch(b){g.log(b)}return"&#9786;"}}},
tinymce:{monkeyPatchUndoManager:!0,instance:d},whitelist:function(a){var d="node"===a.type,c="attribute"===a.type&&"data-title"===a.name;return a.domNode===e?d||c:b.isWhitelisted(f,a)},domReadHook:function(){g.trigger("cursor-target-refresh");j.check()}}}return{bind:function(b,c,e,f){return b.entity({url:d.getServiceUrl(),entityId:d.getEntityId(),jwt:h.getTokenPromise,history:f,presence:!0,useFallback:d.getXhrFallbackFlag()}).bind(e,k(b,c,e))}}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/synchrony-handlers.js' */
define("confluence-collaborative-editor-plugin/synchrony-handlers","jquery ajs confluence/meta confluence-editor/editor/page-editor-message confluence-collaborative-editor-plugin/sync-manager confluence-collaborative-editor-plugin/synchrony-util confluence-collaborative-editor-plugin/synchrony-content confluence-collaborative-editor-plugin/synchrony-presence confluence/get-content-id confluence/legacy-editor-global-AVOID-IF-POSSIBLE".split(" "),function(e,b,f,l,v,d,g,w,n,i){function o(a,p){if(p.contributors){q=
p.contributors;b.unbind(a,o)}}function x(a){j.val(a.rev.toString())}function y(a){j.val(a.rev.toString());b.trigger("synchrony.entity.ack",{pendingChanges:a.pending.length>0})}function z(){m.onDisconnectedState();b.log("Synchrony disconnected!")}function A(a){a.level==="fatal"&&b.trigger("editor.error.message",{disablePublish:true})}function B(a){d.timeEnd("confluence.editor.synchrony.connect");b.log("Synchrony connected.");w.appendTo(a.sid,c,n(),e("#rte-toolbar"),q);m.onConnectedState(c);b.trigger("synchrony.connected");
g.fixTinymceCaretContainer(k,h)}function r(a,b,c){return{origin:"synchrony",cause:a,messageKey:b,disablePublish:c}}function C(a){function b(e){if(!e.pending.length){c.off("ack",b);j.val(e.rev.toString());d.resolve(a)}}var d=e.Deferred();if(c.ackState().pending.length){c.on("ack",b);setTimeout(function(){c.off("ack",b);d.reject(r("timeout"))},5E3)}else d.resolve(a);return e.when(d,s).promise()}function t(a){return(a=d.getLatestRevisionWithAttr(a.revisions,"user"))?a.meta.user:"Anonymous"}
function D(a){if(a.updateType==="remote"){j.val(a.revisions[a.revisions.length-1].rev.toString());if(d.hasRevisionTrigger(a.revisions,"reset")){l.handleMessage("editor.synchrony.revert-page",{type:"info",message:b.format("{0} reverted to a previous version of this page.",t(a))});f.set("has-collaborated",false);u();b.trigger("analyticsEvent",{name:"confluence.synchrony.external-changes.revert"});b.trigger("editor-shared-drafts-discarded");i.heartbeat()}if(d.hasRevisionTrigger(a.revisions,"publish")){if(g.isUnpublished()){f.set("new-page",
false);f.set("page-id",n());f.set("draft-id","0");i.isLimitedModeEnabled()||i.UI.setButtonState(true,e("#rte-button-discard"))}f.set("has-collaborated",false);u();var c=t(a);l.handleMessage("editor.synchrony.page-published",{type:"info",message:b.format("{0} published this page.",c),close:"auto"});b.trigger("analyticsEvent",{name:"confluence.synchrony.external-changes.publish"});b.trigger("editor-shared-drafts-published");i.heartbeat()}d.hasRevisionType(a.revisions,"external")&&
b.trigger("editor.external.change");if((c=d.getLatestRevisionWithAttr(a.revisions,"confVersion"))&&c.meta.confVersion){e('meta[name="page-version"]').attr("content",c.meta.confVersion);e('meta[name="ajs-page-version"]').attr("content",c.meta.confVersion);f.set("page-version",c.meta.confVersion)}}setTimeout(function(){if(a.updateType==="init"||a.updateType==="remote"){b.trigger("editor.remote.change");g.readTitleFromRootElement(k)}g.fixTinymceCaretContainer(k,h);if(a.updateType==="local"){h.undoManager.hasUndo()||
h.setDirty(false);b.trigger("editor.local.change")}},0)}function u(){c.ackState().pending.length===0&&h.setDirty(false)}var j,m,h,k,c,s,q=[];b.bind("editor-heartbeat",o);return{handle:function(a,b,f,l){d.time("confluence.editor.synchrony.connect");c=a;h=b;m=f;s=l.pipe(null,function(a){c.destroy();m.onDisconnectedState();return r(a,"collaborative-editor-load-failure",true)});j=e("#syncRev");k=h.getBody();c.on("init",x).on("update",D).on("ack",y).on("connected",B).on("disconnected",z).on("error",A);
new v(c,{DEBUG_MODE:true});g.bindPostPasteFix();g.readTitleFromRootElement(k);i.overrideBeforeSave(C);e("#content-title").keyup(g.writeTitleToRootElement)}}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-resources', location = '/js/synchrony-editor.js' */
define("confluence-collaborative-editor-plugin/synchrony-editor","window jquery ajs backbone confluence/get-content-id confluence-collaborative-editor-plugin/editor-blanket confluence-collaborative-editor-plugin/synchrony-util confluence-collaborative-editor-plugin/synchrony-content confluence-collaborative-editor-plugin/synchrony-auth confluence-collaborative-editor-plugin/synchrony-entity confluence-collaborative-editor-plugin/synchrony-handlers confluence-editor-loader/editor-loader confluence-editor/support/atlassian-editor-support confluence/meta confluence/api/event confluence/legacy-editor-global-AVOID-IF-POSSIBLE".split(" "),
function(i,e,f,N,z,C,c,s,p,O,P,m,D,E,g,Q){function t(b){e('meta[name="ajs-collaborative-editor-status"]').attr("content",b)}function R(){return!f.Rte.isQuickEdit}function u(b){var a;switch(b){case "timeout":b="The editor didn\'t load this time";a="The connection timed out. If it happens again, speak to your Confluence admin. You may be using a proxy server that prevents WebSocket connections.\u003c/br\u003e\u003ca href=\"#\" id=\"websocketRetry\"\u003eTry again\u003c/a\u003e&nbsp;.&nbsp;\u003ca href=\"https://confluence.atlassian.com/display/CONFKB/Confluence+throws+The+editor+didn%27t+load+this+time+error+when+trying+to+edit+a+page\" target=\"_blank\" id=\"websocketFindmore\"\u003eFind out more\u003c/a\u003e";break;case "synchrony-requests":v=true;b="";a="Something went wrong after loading the editor. Copy your unsaved changes and refresh the page to keep editing.";break;case "limited-mode":v=true;b="";
a="Something went wrong while loading the editor, please try again.";break;default:v=true;b="";a="Loading the editor\'s taking longer than usual. Give it a few moments, then refresh your page if it still doesn\'t load. Speak to your Confluence admin if that doesn\'t fix it."}g.trigger("editor.error.message",{title:b,messageKey:"collaborative-editor-load-failure",message:a,disablePublish:true,close:"manual"})}function F(){g.trigger("dismiss.editor.error.message",{messageKey:"collaborative-editor-load-failure",enablePublish:true})}function G(b,a){var d=e.Deferred();b.done(function(){c.timeEnd(a)},d.resolve);b.fail(function(a){g.trigger("analyticsEvent",
{name:"confluence.synchrony.client.snapshot.request.failure",data:{statusCode:a[0].status,statusText:a[0].statusText}})},d.resolve);return d.promise()}function H(b,a){var d=a[1]==="error"&&a[0].responseText?JSON.parse(a[0].responseText):"",c=false;d.type==="invalid-ancestor"?c="synchrony":d.type==="out-of-order-revision"&&(c="confluence");if(c){i.__DEBUG__&&f.log("Performing synchrony recovery");e.ajax({url:f.contextPath()+"/rest/synchrony/1.0/content/"+z()+"/recovery?behind="+c+"&conflictingRev="+
d["conflicting-rev"],type:"PUT"});return"synchrony-requests"}if(a[1]!=="success"&&b[1]!=="success"||a[1]!=="success"&&d.type!=="duplicate-mismatch"){g.trigger("analyticsEvent",{name:"confluence.synchrony.client.content.reconciliation.failure",data:{type:d.type}});return"synchrony-requests"}return false}function I(b){return p.performRequest(function(a){c.time("confluence.editor.synchrony.snapshot");return G(e.ajax({type:"POST",url:encodeURI(c.getServiceUrl()+"/data"+c.getEntityId()+"?state-at=@head&state-format=type-tagged&rewrite-request=true&cached="+
b),contentType:"text/plain",dataType:"json",data:JSON.stringify({headers:{"content-type":"application/json","x-token":a},method:"GET"})}).pipe(c.asArray,c.asArray),"confluence.editor.synchrony.snapshot")})}function S(b){if(!b.syncRev&&s.isUnpublished()&&(b.raw.length===0||/^\s+$/.test(b.raw)))return e.Deferred().resolve([{},"success"]);if(s.isContentEmpty(b.raw)){g.trigger("analyticsEvent",{name:"confluence.synchrony.client.content.reconciliation.blank-content"});return e.Deferred().resolve([{},"success"])}return p.performRequest(function(a){c.time("confluence.editor.synchrony.CR");
return G(e.ajax({type:"POST",url:encodeURI(c.getServiceUrl()+"/data"+c.getEntityId()+"?optimistic=true&rewrite-request=true"),dataType:"json",contentType:"text/plain",data:JSON.stringify({body:{ancestor:b.syncRev,rev:b.confRev,state:{format:"html",value:b.html},merges:{master:{meta:{type:"client-reconciliation"}}}},headers:{"content-type":"application/json","x-token":a},method:"PUT"})}).pipe(c.asArray,c.asArray),"confluence.editor.synchrony.CR")})}function J(){if(D.isCollaborativeContentType()){var b=
j(K?"rte-collaborative-content-ready":"rte-quick-edit-init rte-collaborative-content-ready",!K),a=j("rte-quick-edit-init rte-collaborative-content-ready rte-collab-editor-loaded",false),d=j("rte-collaborative-content-ready",false,s.getContent),l=j("rte-collab-editor-loaded",false,f.Rte.getEditor),l=j("rte-begin-collab-editing",false,f.Rte.getEditor,R,l);b.pipe(function(){var b=a.promise(),h=d.promise(),n=l.promise(),w=k._initialiseSynchrony();e.when(w,n).pipe(function(a){if(D.isCollaborativeContentType())a.channel({url:c.getServiceUrl(),
topic:E.get("synchrony-app-id")+"/confluence-"+z()+"-page-move",jwt:E.get("synchrony-token")}).on("message",function(a){Q.heartbeat({movedBy:a.data.userFullName})})});var A=x("synchrony.connected.fake"),o=x(null);b.pipe(function(){setTimeout(o.reject,L,"synchrony-requests")});var j=k._initialiseCollabEditingComponents(o),p=Date.now(),q=null,m=null;if(!f.DarkFeatures.isEnabled("synchrony-pessimistic-snapshot")){q=I(true);q.done(function(a){m=a[1]})}var r=b.pipe(function(){return!q||q.state()==="rejected"||
m==="error"||T<Date.now()-p?I(false):q});n.pipe(function(){var a=x("synchrony.connected synchrony.connected.fake");x("synchrony.connected synchrony.connected.fake synchrony-unsupported-extension",L).fail(function(b){u(b);g.trigger("analyticsEvent",{name:"confluence.synchrony.editor.load.timeout"});e("#websocketRetry").on("click",function(){g.trigger("analyticsEvent",{name:"confluence.synchrony.editor.websocket.retry.click"});i.location.reload();return false});e("#websocketFindmore").on("click",function(){g.trigger("analyticsEvent",
{name:"confluence.synchrony.editor.websocket.findmore.click"})});a.done(function(){v||F()})});c.time("confluence.editor.synchrony");e.when(Date.now(),A).pipe(function(a){t("on");var b=Date.now();g.trigger("analyticsEvent",{name:"confluence.synchrony.editor.loaded",data:{durationMillis:b-a}});g.trigger("rte-collab-ready");c.timeEnd("confluence.editor.synchrony");c.timeEnd("confluence.editor")});C.applyBlanket(A)});h.pipe(function(a){var b=S(a);r=e.when(r,w).pipe(function(a,b){c.time("confluence.editor.synchrony.unmarshal");
var d=a;a[1]==="success"&&(d=[{stateAt:a[0].stateAt,state:b.unmarshal(a[0].state.value)},a[1]]);c.timeEnd("confluence.editor.synchrony.unmarshal");return d});e.when(r,b).pipe(function(a,b){var d=H(a,b);d?o.reject(d):o.resolve()});if(!f.DarkFeatures.isEnabled("synchrony-pessimistic-CR")&&(a.syncRevSource==="synchrony-ack"||s.isUnpublished())){i.__DEBUG__&&f.debug("confluence.editor.synchrony: content up to date, not waiting for CR");o.fail(u);return e.when(a,n,r,[{},"success"],j)}return e.when(a,n,
r,b,j)}).pipe(function(a,b,d,c){if(!k._bindEditor(a,b,d,c,o)){g.trigger("analyticsEvent",{name:"confluence.synchrony.bind.failure"});return e.Deferred().reject("editor-binding-failed")}A.resolve()}).fail(function(a){n.always(function(){if(a!=="synchrony-not-enabled"){f.logError("Failed to load the collaborative editor",a);u(a);f.$(function(){y.onDisconnectedState()});t("failed")}})})});d.fail(u);g.trigger("synchrony-events-bound");l.fail(function(a){if(a==="synchrony-not-enabled"){C.showEditor();
t("off");i.__DEBUG__&&f.log("Synchrony is not available in this context.")}})}}function x(b,a,d){var c=e.Deferred();b&&g.bind(b,function h(a,d){i.__DEBUG__&&f.debug("confluence.editor.synchrony.event: "+a.type+"."+a.namespace);g.unbind(b,h);c.resolve(d)});a&&setTimeout(c.reject,a,d||"timeout");return c}function j(b,a,d,l,j){var h=j||e.Deferred();if(c.isEditorInitialised()||a&&c.synchronyReady())return M(h,d);g.bind(b,function w(a,c){i.__DEBUG__&&f.debug("confluence.editor.event "+a.type+"."+a.namespace);
h.always(function(){g.unbind(b,w)});M(h,d,c,l)});return h}function M(b,a,d,e){if(!c.synchronyReady())return b.reject("synchrony-not-enabled");if(!e||e())return(a=a?a(d):d)&&a.error?b.reject(a.error):b.resolve(a);return b}var k={},B=i.Synchrony=i.Synchrony||{};c.time("confluence.editor.synchrony.jsLoad");var T=6E5,L=3E4,y,v=false,K=e("#confluence-ui").length;k._bindEditor=function(b,a,d,l,j){c.time("confluence.editor.synchrony.init");if(H(d,l))return null;var l=e("#syncRev"),h=null;if(d[1]==="success"){d=
d[0];h={base:{rev:B.rev(d.stateAt),state:d.state}};l.val(h.base.rev.toString())}i.__DEBUG__&&f.log("Synchrony will load with contentId: ",z());try{var n=a.getBody();n.setAttribute("data-title",b.title);var k=O.bind(B,a,n,h);P.handle(k,a,y,j);g.trigger("editor.remote.change");a.setDirty(false);c.timeEnd("confluence.editor.synchrony.init");return k}catch(m){f.logError(m);return null}};k._initialiseCollabEditingComponents=function(b){var a=e.Deferred();f.$(function(){f.$("body").addClass("synchrony-active");
y=new (require("confluence-collaborative-editor-plugin/status-indicator-view"))({el:"#pluggable-status",model:new N.Model({minActiveTime:500})});p.init(y);a.resolve()});e(i).one("synchrony.connected.fake",function(c){if(c.namespace==="connected.fake"){a.resolve();b.resolve();F();t("fake")}});return a};k._initialiseSynchrony=function(){c.time("confluence.editor.synchrony.deps");var b=i,a=b.Synchrony=b.Synchrony||{};if(!a.ready){var d=a._cbs=a._cbs||[];a.ready=function(a){d.push(a)}}var f=function(){if(a.state===
1){a.SockJS=b.SockJS;a.init()}};if(b.SockJS)a.init&&f();else{var g=b._sockjs_onload;b._sockjs_onload=function(){f();g&&g.apply(this,arguments)}}var h=e.Deferred();B.ready(h.resolve);return e.when(h.promise(),c.loadScript("/js/vendor/sockjs.min.js"),c.loadScript("/js/synchrony.min.js")).pipe(function(a){c.timeEnd("confluence.editor.synchrony.deps");i.__DEBUG__&&console.info("Synchrony successfully initialised.");return a})};k.init=function(){m.getEditorLoadingStatus()&&m.getEditorLoadingStatus().done?
m.getEditorLoadingStatus().done(J):J()};c.timeEnd("confluence.editor.synchrony.jsLoad");return k});require("confluence/module-exporter").safeRequire("confluence-collaborative-editor-plugin/synchrony-editor",function(i){i.init()});
}catch(e){WRMCB(e)};